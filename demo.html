<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
<title>Pollution demo</title>
<!-- <script src="assets/libraries/d3.v3.min.js"></script> -->
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="assets/libraries/queue.v1.min.js"></script>

<style>

body {
  font: 10px sans-serif;
}

.y.axis path {
	fill:none;
}
.y.axis line {
  fill: none;
  stroke:rgb(200,200,200);
  shape-rendering: crispEdges;
}

.x.axis path {
  display: none;
}

.line {
  fill: none;
  stroke: black;
  stroke-width: 1.5px;
}

.y.axis.notext text {
	display:none;
}

.axis-label {
	font-size:14px;
}
.param-label {
	font-size:13px;
}
.title {
	font-size:20px;
	font-family:'Franklin Gothic Medium';
}
.subtitle {
	font-family:Arial;
	font-size:14px;
}
.legend-label, .line-label {
	font-family: Arial;
	font-size:12px;
}

#tooltip {
	position: absolute;
	width: auto;
	height: auto;
	padding: 0px 10px;
	background-color: white;
	-webkit-border-radius: 10px;
	-moz-border-radius: 10px;
	border-radius: 10px;
	-webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
	-moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
	box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
	pointer-events: none;
}

#tooltip.hidden {
	display: none;
}


</style>
</head>

<body>
<div id="main">
	<div id="chartContainer"></div>

	<div id="tooltip" class="hidden" style="left: 429px, top: 489.6px">
		<p><span id="station">Station</span>: <span id="PM25">50</span></p>
	</div>
</div>

</body>

<script>

function mouseover(d) {
	console.log(d3.select(this));

	var mousecoord = [0,0];
	mousecoord = d3.mouse(this);

	d3.select("#tooltip")
		.style("left", mousecoord[0]+25 + "px")
		.style("top", mousecoord[1]-75 + "px");

	d3.select("#station")
		.text(d.station);

	d3.select("#PM25")
		.text(d.pm25_aqi);
	   
	d3.select("#tooltip").classed("hidden", false);
};

function mouseout(d) {
	d3.select("#tooltip").classed("hidden", true);
};

//DATA PROCESSING FUNCTIONS
function processData(d, i) { 

	function deString(d) {
		if (d==="") {
			return NaN;
		} else {
			return +d;
		}
	}

	var format = d3.time.format("%Y-%m-%d %X");

	var array = {
		station: d.station,
		date: format.parse(d.dt_clean),
		pm25_aqi: deString(d.pm25_aqi),
		pm25_aqi_ins: deString(d.pm25_aqi_ins)
	};
	return array;
}

//THE DATA QUEUE
// queue()
// 	.defer(d3.csv, "assets/data/aqi_hourly_spring_ihbas.csv", processData)
// 	.defer(d3.csv, "assets/data/aqi_hourly_winter_ihbas.csv", processData)
// 	.await(ready);


// SKETCHBOOK
function sketchBook(observations) {
	console.log("In sketchBook.");

	console.table(observations.slice(0,10));

	// Following Eric's lead on sizing stuff
	var chartSize = {
		width: 600,
		height: 400
	};
	var chartGap = 20;

	var margin = {top: 100, right: 30, bottom: 100, left: 50};

	var svg = d3.select("body").append("svg")
	    .attr("width", chartSize.width + margin.left + margin.right)
	    .attr("height", chartSize.height + margin.top + margin.bottom);

	var panel = svg
	  	.append("g")
	  	.attr("width", chartSize.width)
	    .attr("height", chartSize.height)
	    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	panel.append('text')
		.attr('x', 35)
		.attr('y', 70)
		.attr('class','title')
		.text('Predicting pollution');

	// I tell myself this is because we have an EPoD standard CSS. :) 
	panel.append('text')
		.attr('x', 35)
		.attr('y', 50)
		.attr('class','subtitle')
		.text('A demo by EPoD')

	panel.append('text')
		.attr('x', 35)
		.attr('y',chartSize.height + 50)
		.attr('class','legend-label')
		.text('Actual vs. predicted, for August 2015.')


	var bandColors = ['rgb(165,0,38)','rgb(215,48,39)','rgb(244,109,67)','rgb(253,174,97)','rgb(166,217,106)','rgb(26,152,80)'];
	var bandLabels = ['Severe','Very Poor','Poor','Moderate','Satisfactory','Good']
	bandColors.reverse();
	bandLabels.reverse();
	var cutoffs = [0,50,100,200,300,400,500];
	var parameters = ['Ammonia','Carbon Monoxide','Nitrogen Dioxide','Particulate Matter 2.5','Sulfur Dioxide'];
	var paramDict = {
		'Ammonia':'nh3_aqi',
		'Carbon Monoxide':'co_aqi',
		'Nitrogen Dioxide':'no2_aqi',
		'Particulate Matter 2.5':'pm25_aqi',
		'Sulfur Dioxide':'so2_aqi'
	}

	// TODO: Pick a time range. Week? 10-days?
	var x = d3.time.scale()
    	.range([0, chartSize.width]);

	var y = d3.scale.linear()
	    .range([chartSize.height, 0]);

	x.domain(d3.extent(observations, function(d) { return d.date; }));
	y.domain(d3.extent(observations, function(d) { return d.pm25_aqi; }));

	var line = d3.svg.line()
	    .x(function(d) { return x(d.date); })
	    .y(function(d) { return y(d.pm25_aqi); });

	panel.append("path")
		.datum(observations)
		.attr("class", "line")
		.attr("d", line)
		.on("mousemove", mouseover)
		.on("mouseout", mouseout);

	var xAxis = d3.svg.axis()
	    .scale(x)
	    .orient("bottom")
	    .ticks(7)
	    .tickFormat(d3.time.format("%b %d"));	

	var yAxis = d3.svg.axis()
	    .scale(y)
	    .orient("left");

	panel.append("g")
	      .attr("class", "y axis")
	      .call(yAxis)
	    .append("text")
	      .attr("transform", "rotate(-90)")
	      .attr("y", 6)
	      .attr("dy", ".71em")
	      .style("text-anchor", "end")
	      .text("Price ($)");

	panel.append("g")
	      .attr("class", "x axis")
	      .attr("transform", "translate(0," + chartSize.height + ")")
	      .call(xAxis);

} //sketchBook

d3.csv("data-cleaning/august_pm25.csv", processData, sketchBook)


</script>
</html>
